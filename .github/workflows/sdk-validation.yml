name: SDK Í≤ÄÏ¶ù ÏûêÎèôÌôî ÌÖåÏä§Ìä∏

on:
  # Manual trigger - ÏàòÎèô Ïã§Ìñâ
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Ïã§ÌñâÌï† Test Suite'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - read_only
          - writeget_only
          - notify_only

  # Schedule - Îß§Ïùº Ïò§Ï†Ñ 9Ïãú (KST)
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 = KST 09:00

  # Push to main - main Î∏åÎûúÏπòÏóê pushÎê† Îïå
  push:
    branches:
      - main
    paths:
      - 'tests/**'
      - 'scripts/**'
      - '.github/workflows/sdk-validation.yml'

jobs:
  test:
    name: SDK Í≤ÄÏ¶ù ÌÖåÏä§Ìä∏
    runs-on: self-hosted  # Self-hosted runner ÏÇ¨Ïö© (Ïã§Ï†ú ÎîîÎ∞îÏù¥Ïä§ ÌïÑÏöî)

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîç Check Android device
        run: |
          echo "Checking for connected Android devices..."
          adb devices
          adb shell getprop ro.build.version.release

      - name: üîç Check Appium server
        run: |
          echo "Checking if Appium server is running..."
          curl -s http://localhost:4723/status || echo "‚ö†Ô∏è  Appium server may not be running"

      - name: üß™ Run regression tests
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          APPIUM_SERVER_URL: http://localhost:4723/wd/hub
          APPIUM_DEVICE_NAME: ${{ secrets.DEVICE_ID || '55ETQWBXYE1RA1' }}
          BLE_DEVICE_SERIAL: ${{ secrets.BLE_DEVICE_SERIAL }}
        run: |
          # Stop app first
          adb shell am force-stop com.wellysis.spatch.sdk.sample || true
          sleep 2

          # Determine which tests to run
          TEST_PATH="tests/regression/test_regression.py"
          if [ "${{ github.event.inputs.test_suite }}" = "read_only" ]; then
            TEST_PATH="tests/regression/test_regression.py::TestReadScreen"
          elif [ "${{ github.event.inputs.test_suite }}" = "writeget_only" ]; then
            TEST_PATH="tests/regression/test_regression.py::TestWriteGetScreen"
          elif [ "${{ github.event.inputs.test_suite }}" = "notify_only" ]; then
            TEST_PATH="tests/regression/test_regression.py::TestNotifyScreen"
          fi

          # Run tests
          python -m pytest $TEST_PATH \
            -v \
            --html=test-report.html \
            --self-contained-html \
            --json-report \
            --json-report-file=.report.json \
            --tb=short \
            || true  # Don't fail workflow on test failure

      - name: üìä Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-${{ github.run_number }}
          path: |
            test-report.html
            .report.json
            *.png
          retention-days: 30

      - name: üì§ Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            python scripts/send_slack_notification.py || echo "‚ö†Ô∏è  Failed to send Slack notification"
          else
            echo "‚ö†Ô∏è  SLACK_WEBHOOK_URL secret not configured"
          fi

      - name: üìà Generate test summary
        if: always()
        run: |
          echo "## üìä Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f .report.json ]; then
            python .github/scripts/generate_test_summary.py >> $GITHUB_STEP_SUMMARY
          fi

      - name: ‚ùå Fail if tests failed
        if: always()
        run: |
          if [ -f .report.json ]; then
            python .github/scripts/check_test_failure.py
          fi
