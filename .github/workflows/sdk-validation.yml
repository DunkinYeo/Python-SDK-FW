name: SDK ê²€ì¦ ìë™í™” í…ŒìŠ¤íŠ¸

on:
  # Manual trigger - ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'ì‹¤í–‰í•  í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - read_only
          - writeget_only
          - notify_only

  # Schedule - ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST)
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 = KST 09:00

  # Push to main - main ë¸Œëœì¹˜ì— pushë  ë•Œ
  push:
    branches:
      - main
    paths:
      - 'tests/**'
      - 'scripts/**'
      - '.github/workflows/sdk-validation.yml'

jobs:
  test:
    name: SDK ê²€ì¦ í…ŒìŠ¤íŠ¸
    runs-on: self-hosted  # Self-hosted runner ì‚¬ìš© (ì‹¤ì œ ë””ë°”ì´ìŠ¤ í•„ìš”)

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Check Android device
        run: |
          echo "Checking for connected Android devices..."
          adb devices
          adb shell getprop ro.build.version.release

      - name: ğŸ” Check Appium server
        run: |
          echo "Checking if Appium server is running..."
          curl -s http://localhost:4723/status || echo "âš ï¸  Appium server may not be running"

      - name: ğŸ§ª Run regression tests
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          APPIUM_SERVER_URL: http://localhost:4723/wd/hub
          APPIUM_DEVICE_NAME: ${{ secrets.DEVICE_ID || '55ETQWBXYE1RA1' }}
          BLE_DEVICE_SERIAL: ${{ secrets.BLE_DEVICE_SERIAL }}
        run: |
          # Stop app first
          adb shell am force-stop com.wellysis.spatch.sdk.sample || true
          sleep 2

          # Determine which tests to run
          TEST_PATH="tests/regression/test_regression.py"
          if [ "${{ github.event.inputs.test_suite }}" = "read_only" ]; then
            TEST_PATH="tests/regression/test_regression.py::TestReadScreen"
          elif [ "${{ github.event.inputs.test_suite }}" = "writeget_only" ]; then
            TEST_PATH="tests/regression/test_regression.py::TestWriteGetScreen"
          elif [ "${{ github.event.inputs.test_suite }}" = "notify_only" ]; then
            TEST_PATH="tests/regression/test_regression.py::TestNotifyScreen"
          fi

          # Run tests
          python -m pytest $TEST_PATH \
            -v \
            --html=test-report.html \
            --self-contained-html \
            --json-report \
            --json-report-file=.report.json \
            --tb=short \
            || true  # Don't fail workflow on test failure

      - name: ğŸ“Š Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-${{ github.run_number }}
          path: |
            test-report.html
            .report.json
            *.png
          retention-days: 30

      - name: ğŸ“¤ Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            python scripts/send_slack_notification.py || echo "âš ï¸  Failed to send Slack notification"
          else
            echo "âš ï¸  SLACK_WEBHOOK_URL secret not configured"
          fi

      - name: ğŸ“ˆ Generate test summary
        if: always()
        run: |
          echo "## ğŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f .report.json ]; then
            python -c "
import json
with open('.report.json') as f:
    report = json.load(f)
    summary = report.get('summary', {})
    total = summary.get('total', 0)
    passed = summary.get('passed', 0)
    failed = summary.get('failed', 0)
    duration = report.get('duration', 0)

    print(f'**Total Tests:** {total}')
    print(f'**âœ… Passed:** {passed}')
    print(f'**âŒ Failed:** {failed}')
    print(f'**â±ï¸  Duration:** {duration:.1f}s')
    print(f'**ğŸ“Š Pass Rate:** {passed/total*100:.1f}%' if total > 0 else '**ğŸ“Š Pass Rate:** N/A')
            " >> $GITHUB_STEP_SUMMARY
          fi

      - name: âŒ Fail if tests failed
        if: always()
        run: |
          if [ -f .report.json ]; then
            python -c "
import json, sys
with open('.report.json') as f:
    report = json.load(f)
    failed = report.get('summary', {}).get('failed', 0)
    if failed > 0:
        print(f'âŒ {failed} test(s) failed')
        sys.exit(1)
    else:
        print('âœ… All tests passed')
            "
          fi
